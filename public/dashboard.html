<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramal - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Input para upload de foto (escondido) -->
    <input type="file" id="photoUploadDashboard" accept="image/*" style="display: none;">

    <div class="header">
        <div class="logo-section">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                </svg>
            </div>
            <div class="logo-text">
                <h1>Ramal</h1>
                <p>Sistema de Ramais Corporativos</p>
            </div>
        </div>
        <div class="user-section">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
            <div class="user-info" onclick="toggleDropdown()">
                <div id="userAvatarContainer" class="user-avatar">RC</div>
                <div class="user-details">
                    <h3 id="userName">Carregando...</h3>
                    <p>Administrador</p>
                </div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item" onclick="changeProfilePhoto()">
                        <svg viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Alterar Foto
                    </div>
                    <div class="dropdown-item" onclick="viewProfile()">
                        <svg viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        Meu Perfil
                    </div>
                    <div class="dropdown-item" onclick="viewSettings()">
                        <svg viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                        Configurações
                    </div>
                    <div class="dropdown-item danger" onclick="logout()">
                        <svg viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                        </svg>
                        Sair
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-area">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value" id="callsToday">0</div>
                    <div class="stat-label">Chamadas Hoje</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon amber">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value" id="avgCallTime">0:00</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon emerald">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value" id="activeUsers">0/0</div>
                    <div class="stat-label">Ramais Ativos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon rose">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 3.75L18 6m0 0l2.25 2.25M18 6l2.25-2.25M18 6l-2.25 2.25m1.5 13.5c-8.284 0-15-6.716-15-15V4.5A2.25 2.25 0 014.5 2.25h1.372c.516 0 .966.351 1.091.852l1.106 4.423c.11.44-.054.902-.417 1.173l-1.293.97a1.062 1.062 0 00-.38 1.21 12.035 12.035 0 007.143 7.143c.441.162.928-.004 1.21-.38l.97-1.293a1.125 1.125 0 011.173-.417l4.423 1.106c.5.125.852.575.852 1.091V19.5a2.25 2.25 0 01-2.25 2.25h-2.25z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value" id="missedCalls">0</div>
                    <div class="stat-label">Perdidas</div>
                </div>
            </div>

            <div class="extensions-panel">
                <div class="panel-header">
                    <h2>Ramais Corporativos</h2>
                    <div class="search-box">
                        <svg class="search-icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                        <input type="text" placeholder="Buscar ramal ou nome..." id="searchInput">
                    </div>
                </div>

                <div id="extensionsList">
                    <!-- Ramais serão carregados dinamicamente -->
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <svg viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                    </svg>
                    Histórico de Chamadas
                </div>
                <div id="callHistoryList">
                    <!-- Histórico será carregado dinamicamente -->
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-header">
                    <svg viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                    </svg>
                    Mensagens Internas
                </div>
                <div id="messagesList">
                    <!-- Mensagens serão carregadas dinamicamente -->
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-header">
                    <svg viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    Salas Ativas
                </div>
                <div id="activeRoomsList">
                    <!-- Salas ativas serão carregadas dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <div class="floating-buttons">
        <button class="fab white" onclick="openSettings()">
            <svg viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
        </button>
        <button class="fab blue" onclick="openHelp()">
            <svg viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
            </svg>
        </button>
    </div>

    <script>
        // Sistema de sincronização do dashboard
        class DashboardSync {
            constructor() {
                this.socket = io();
                this.unreadMessages = new Map();
                this.allUsers = [];
                this.init();
            }

            init() {
                this.setupSocketListeners();
                this.loadRealTimeData();
                this.setupEventListeners();
            }

            setupSocketListeners() {
                // Atualizar lista de usuários online
                this.socket.on("user-list", (users) => {
                    this.allUsers = users;
                    this.updateOnlineUsers(users);
                    this.updateExtensionsList(users);
                });

                // Receber notificação de nova mensagem
                this.socket.on("chatMessage", (data) => {
                    this.handleNewMessage(data);
                });

                // Receber notificações do dashboard
                this.socket.on("dashboard-notification", (data) => {
                    this.handleDashboardNotification(data);
                });

                // Atualizar dados do dashboard
                this.socket.on("dashboard-data", (data) => {
                    this.updateDashboardStats(data);
                });

                // Sincronizar chamadas
                this.socket.on("webrtc-offer", (data) => {
                    this.updateCallHistory({
                        type: 'incoming_call',
                        from: data.fromName,
                        timestamp: new Date().toISOString()
                    });
                });

                this.socket.on("webrtc-answer", (data) => {
                    this.updateCallHistory({
                        type: 'answered_call',
                        timestamp: new Date().toISOString()
                    });
                });

                this.socket.on("webrtc-reject", (data) => {
                    this.updateCallHistory({
                        type: 'rejected_call',
                        timestamp: new Date().toISOString()
                    });
                });

                this.socket.on("webrtc-endcall", (data) => {
                    this.updateCallHistory({
                        type: 'ended_call',
                        timestamp: new Date().toISOString()
                    });
                });

                // Registrar usuário no dashboard
                const session = localStorage.getItem('cloudpbx_session');
                if (session) {
                    const userData = JSON.parse(session);
                    this.socket.emit("register", { name: userData.nome });
                }
            }

            setupEventListeners() {
                // Busca de ramais
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterExtensions(e.target.value);
                    });
                }

                // Atualizar dados a cada 30 segundos
                setInterval(() => {
                    this.loadRealTimeData();
                }, 30000);
            }

            updateOnlineUsers(users) {
                const onlineCount = users.filter(u => u.online).length;
                const totalCount = users.length;
                
                // Atualizar estatística de ramais ativos
                document.getElementById('activeUsers').textContent = `${onlineCount}/${totalCount}`;
            }

            updateExtensionsList(users) {
                const extensionsList = document.getElementById('extensionsList');
                if (!extensionsList) return;

                extensionsList.innerHTML = '';

                // Filtrar para não mostrar o próprio usuário
                const otherUsers = users.filter(user => user.name !== this.getCurrentUserName());
                
                otherUsers.forEach((user, index) => {
                    const extensionItem = document.createElement('div');
                    extensionItem.className = 'extension-item';
                    
                    const statusClass = user.online ? 'available' : 'offline';
                    const statusText = user.online ? 'Disponível' : 'Offline';
                    const ramalNumber = 1000 + index + 1;
                    const department = this.getUserDepartment(user.name);

                    extensionItem.innerHTML = `
                        <div class="extension-info">
                            <div class="extension-avatar">
                                <div class="avatar-circle">${this.getInitials(user.name)}</div>
                                <div class="status-indicator ${statusClass}"></div>
                            </div>
                            <div class="extension-details">
                                <h3>${user.name}</h3>
                                <div class="extension-meta">
                                    <span>Ramal ${ramalNumber}</span>
                                    <span>•</span>
                                    <span>${department}</span>
                                    <span class="status-badge-inline ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                        <div class="extension-actions">
                            <button class="action-btn primary" onclick="makeCallToUser(${JSON.stringify(user).replace(/"/g, '&quot;')})" ${!user.online ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" class="icon-phone">
                                    <path fill="currentColor" d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24c1.12.37 2.33.57 3.57.57c.55 0 1 .45 1 1V20c0 .55-.45 1-1 1c-9.39 0-17-7.61-17-17c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1c0 1.25.2 2.45.57 3.57c.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                </svg>
                            </button>
                            <button class="action-btn secondary" onclick="sendMessageToUser(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                                <svg viewBox="0 0 24 24" class="icon-message">
                                    <path fill="currentColor" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                                </svg>
                            </button>
                            <button class="action-btn secondary" onclick="startVideoCallToUser(${JSON.stringify(user).replace(/"/g, '&quot;')})" ${!user.online ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" class="icon-video">
                                    <path fill="currentColor" d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                                </svg>
                            </button>
                        </div>
                    `;

                    if (user.avatar) {
                        const avatarElement = extensionItem.querySelector('.avatar-circle');
                        this.updateAvatarElement(avatarElement, user.name, user.avatar);
                    }

                    extensionsList.appendChild(extensionItem);
                });
            }

            getCurrentUserName() {
                const session = localStorage.getItem('cloudpbx_session');
                if (session) {
                    const userData = JSON.parse(session);
                    return userData.nome;
                }
                return '';
            }

            filterExtensions(searchTerm) {
                const extensionItems = document.querySelectorAll('.extension-item');
                const searchLower = searchTerm.toLowerCase().trim();
                
                extensionItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchLower)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            handleNewMessage(data) {
                // Não mostrar notificação se a mensagem for do próprio usuário
                if (data.from === this.getCurrentUserName()) return;
                
                // Incrementar contador de mensagens não lidas
                const currentUnread = this.unreadMessages.get(data.from) || 0;
                this.unreadMessages.set(data.from, currentUnread + 1);
                
                // Atualizar sidebar de mensagens
                this.updateMessagesSidebar(data);
                
                // Mostrar notificação
                this.showMessageNotification(data);
            }

            updateMessagesSidebar(data) {
                const messagesList = document.getElementById('messagesList');
                if (!messagesList) return;

                // Criar ou atualizar item de mensagem
                let messageItem = messagesList.querySelector(`[data-user="${data.from}"]`);
                
                if (!messageItem) {
                    messageItem = document.createElement('div');
                    messageItem.className = 'message-item unread';
                    messageItem.setAttribute('data-user', data.from);
                    
                    messageItem.innerHTML = `
                        <div class="item-header">
                            <h4>${data.from}</h4>
                            <span class="item-time">${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="message-text">${data.text || 'Nova mensagem'}</p>
                        <span class="unread-badge">Nova</span>
                    `;
                    
                    messageItem.onclick = () => this.openChatWithUser(data.from);
                    messagesList.appendChild(messageItem);
                } else {
                    // Atualizar mensagem existente
                    messageItem.querySelector('.message-text').textContent = data.text || 'Nova mensagem';
                    messageItem.querySelector('.item-time').textContent = 
                        new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    messageItem.classList.add('unread');
                }

                // Manter apenas as 5 mensagens mais recentes
                const allMessages = messagesList.querySelectorAll('.message-item');
                if (allMessages.length > 5) {
                    allMessages[allMessages.length - 1].remove();
                }
            }

            handleDashboardNotification(data) {
                switch (data.type) {
                    case 'new_call':
                        this.updateCallHistory(data);
                        break;
                    case 'room_created':
                        this.updateActiveRooms(data);
                        break;
                }
            }

            updateCallHistory(callData) {
                const callHistoryList = document.getElementById('callHistoryList');
                if (!callHistoryList) return;

                const callItem = document.createElement('div');
                callItem.className = 'call-item';
                
                let callType, callIcon, strokeColor, contact, duration;
                
                switch (callData.type) {
                    case 'incoming_call':
                        callType = 'Recebida';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />';
                        strokeColor = '#3b82f6';
                        contact = callData.from || 'Usuário';
                        duration = '0:00';
                        break;
                        
                    case 'outgoing_call':
                        callType = 'Realizada';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />';
                        strokeColor = '#10b981';
                        contact = callData.to || 'Usuário';
                        duration = '0:00';
                        break;
                        
                    case 'answered_call':
                        callType = 'Atendida';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />';
                        strokeColor = '#10b981';
                        contact = callData.from || 'Usuário';
                        duration = callData.duration || '0:00';
                        break;
                        
                    case 'rejected_call':
                        callType = 'Rejeitada';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />';
                        strokeColor = '#ef4444';
                        contact = callData.from || 'Usuário';
                        duration = '0:00';
                        break;
                        
                    case 'ended_call':
                        callType = 'Encerrada';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />';
                        strokeColor = '#6b7280';
                        contact = callData.from || 'Usuário';
                        duration = callData.duration || '0:00';
                        break;
                        
                    default:
                        callType = 'Chamada';
                        callIcon = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />';
                        strokeColor = '#3b82f6';
                        contact = callData.from || 'Usuário';
                        duration = '0:00';
                }
                
                callItem.innerHTML = `
                    <div class="item-header">
                        <h4>${contact}</h4>
                        <span class="item-time">${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="call-details">
                        <div class="call-type">
                            <svg viewBox="0 0 24 24" stroke="${strokeColor}">
                                ${callIcon}
                            </svg>
                            ${callType}
                        </div>
                        <span class="call-duration">${duration}</span>
                    </div>
                `;

                // Adicionar no início da lista
                callHistoryList.insertBefore(callItem, callHistoryList.firstChild);
                
                // Atualizar estatísticas
                this.updateCallStats(callData.type);
                
                // Manter apenas as 5 chamadas mais recentes
                const allCalls = callHistoryList.querySelectorAll('.call-item');
                if (allCalls.length > 5) {
                    allCalls[allCalls.length - 1].remove();
                }
            }

            updateCallStats(callType) {
                const callsTodayElement = document.getElementById('callsToday');
                const missedCallsElement = document.getElementById('missedCalls');
                
                if (callsTodayElement) {
                    const currentCalls = parseInt(callsTodayElement.textContent) || 0;
                    callsTodayElement.textContent = currentCalls + 1;
                }
                
                if (missedCallsElement && (callType === 'rejected_call' || callType === 'ended_call')) {
                    const currentMissed = parseInt(missedCallsElement.textContent) || 0;
                    missedCallsElement.textContent = currentMissed + 1;
                }
            }

            updateActiveRooms(roomData) {
                const activeRoomsList = document.getElementById('activeRoomsList');
                if (!activeRoomsList) return;

                const roomItem = document.createElement('div');
                roomItem.className = 'message-item';
                
                roomItem.innerHTML = `
                    <div class="item-header">
                        <h4>${roomData.roomName}</h4>
                        <span class="item-time">Agora</span>
                    </div>
                    <p class="message-text">Criada por ${roomData.creator}</p>
                `;

                activeRoomsList.insertBefore(roomItem, activeRoomsList.firstChild);

                // Manter apenas as 3 salas mais recentes
                const allRooms = activeRoomsList.querySelectorAll('.message-item');
                if (allRooms.length > 3) {
                    allRooms[allRooms.length - 1].remove();
                }
            }

            updateDashboardStats(data) {
                if (data.callsToday !== undefined) {
                    document.getElementById('callsToday').textContent = data.callsToday;
                }
                if (data.missedCalls !== undefined) {
                    document.getElementById('missedCalls').textContent = data.missedCalls;
                }
                if (data.activeUsers !== undefined) {
                    document.getElementById('activeUsers').textContent = `${data.onlineUsers}/${data.totalUsers}`;
                }
                
                // Calcular tempo médio de chamada
                if (data.recentCalls && data.recentCalls.length > 0) {
                    const totalDuration = data.recentCalls.reduce((sum, call) => sum + (call.duration || 0), 0);
                    const avgDuration = totalDuration / data.recentCalls.length;
                    const minutes = Math.floor(avgDuration / 60);
                    const seconds = Math.floor(avgDuration % 60);
                    document.getElementById('avgCallTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            showMessageNotification(data) {
                this.showDashboardNotification(`Nova mensagem de ${data.from}`);
            }

            showDashboardNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'dashboard-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 2rem;
                    background: #10b981;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 10000;
                    animation: slideInRight 0.3s ease;
                    font-weight: 600;
                    font-size: 14px;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            loadRealTimeData() {
                // Carregar dados iniciais do servidor
                this.socket.emit('get-dashboard-data');
                
                // Carregar histórico de chamadas via API
                fetch('/api/call-history')
                    .then(response => response.json())
                    .then(calls => {
                        this.updateCallHistoryList(calls);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar histórico de chamadas:', error);
                    });
            }

            updateCallHistoryList(calls) {
                const callHistoryList = document.getElementById('callHistoryList');
                if (!callHistoryList) return;

                callHistoryList.innerHTML = '';

                calls.slice(0, 5).forEach(call => {
                    const callItem = document.createElement('div');
                    callItem.className = 'call-item';
                    
                    const callType = call.type === 'outgoing' ? 'Realizada' : 'Recebida';
                    const strokeColor = call.answered ? '#10b981' : '#ef4444';
                    const duration = call.duration ? this.formatDuration(call.duration) : '0:00';
                    
                    callItem.innerHTML = `
                        <div class="item-header">
                            <h4>${call.from}</h4>
                            <span class="item-time">${new Date(call.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="call-details">
                            <div class="call-type">
                                <svg viewBox="0 0 24 24" stroke="${strokeColor}">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                                </svg>
                                ${callType} ${call.answered ? '' : '(Não atendida)'}
                            </div>
                            <span class="call-duration">${duration}</span>
                        </div>
                    `;

                    callHistoryList.appendChild(callItem);
                });
            }

            // Funções utilitárias
            getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }

            getUserDepartment(name) {
                const departments = ['Vendas', 'Suporte', 'Marketing', 'TI', 'Financeiro', 'RH'];
                const hash = name.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                return departments[hash % departments.length];
            }

            formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            updateAvatarElement(element, userName, avatar) {
                if (avatar) {
                    element.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = avatar;
                    img.alt = 'Avatar';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.borderRadius = '50%';
                    img.style.objectFit = 'cover';
                    element.appendChild(img);
                } else {
                    element.textContent = this.getInitials(userName);
                }
            }

            openChatWithUser(userName) {
                window.location.href = `chat.html?user=${encodeURIComponent(userName)}`;
            }
        }

        // Inicializar dashboard
        let dashboardSync;

        // Funções globais
        function makeCallToUser(user) {
            if (window.makeCallToUser && typeof window.makeCallToUser === 'function') {
                window.makeCallToUser(user);
            } else {
                dashboardSync.showDashboardNotification(`Chamando ${user.name}...`);
                // Em um ambiente real, isso iniciaria uma chamada WebRTC
            }
        }

        function sendMessageToUser(user) {
            window.location.href = `chat.html?user=${encodeURIComponent(user.name)}`;
        }

        function startVideoCallToUser(user) {
            dashboardSync.showDashboardNotification(`Videochamada com ${user.name} em desenvolvimento`);
        }

        // Sistema de temas e perfil
        function getUserKey(key) {
            const currentUser = localStorage.getItem('currentUser');
            return currentUser ? `${currentUser}_${key}` : key;
        }

        function identifyUser() {
            const session = localStorage.getItem('cloudpbx_session');
            if (session) {
                const userData = JSON.parse(session);
                const userIdentifier = userData.email || userData.nome.replace(/\s+/g, '_').toLowerCase();
                localStorage.setItem('currentUser', userIdentifier);
            }
        }

        function loadUserProfile() {
            const session = localStorage.getItem('cloudpbx_session');
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const userData = JSON.parse(session);
            document.getElementById('userName').textContent = userData.nome;
            
            // Carregar foto do perfil
            updateAvatar();
            applyTheme();
        }

        function updateAvatar() {
            const photoUrl = localStorage.getItem(getUserKey('userPhoto'));
            const avatarContainer = document.getElementById('userAvatarContainer');
            const userName = document.getElementById('userName').textContent;
            
            // Gerar iniciais para o avatar
            const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            if (photoUrl) {
                // Se houver foto, criar elemento img
                avatarContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = photoUrl;
                img.alt = 'Avatar';
                img.className = 'user-avatar-image';
                avatarContainer.appendChild(img);
            } else {
                // Se não houver foto, mostrar iniciais
                avatarContainer.textContent = initials;
                avatarContainer.className = 'user-avatar';
            }
        }

        function changeProfilePhoto() {
            document.getElementById('photoUploadDashboard').click();
        }

        function applyTheme() {
            const theme = localStorage.getItem(getUserKey('colorTheme')) || 'blue';
            const darkMode = localStorage.getItem(getUserKey('darkMode')) === 'true';
            
            document.body.className = ''; // Reset classes
            
            if (darkMode) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.add(`${theme}-theme`);
            }
        }

        function applyDarkMode() {
            const darkMode = localStorage.getItem(getUserKey('darkMode')) === 'true';
            const theme = localStorage.getItem(getUserKey('colorTheme')) || 'blue';
            
            document.body.className = ''; // Reset classes
            
            if (darkMode) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.add(`${theme}-theme`);
            }
        }

        // Inicialização quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            identifyUser();
            loadUserProfile();
            applyDarkMode();
            
            // Inicializar sistema de sincronização
            dashboardSync = new DashboardSync();
            
            // Configurar upload de foto
            const photoUpload = document.getElementById('photoUploadDashboard');
            if (photoUpload) {
                photoUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.size <= 2000000) { // 2MB limit
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const photoUrl = event.target.result;
                            localStorage.setItem(getUserKey('userPhoto'), photoUrl);
                            updateAvatar();
                            dashboardSync.showDashboardNotification('Foto de perfil atualizada com sucesso!');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('Arquivo muito grande. Máximo 2MB.');
                    }
                });
            }
        });

        // Funções do menu dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        function viewProfile() {
           window.location.href = 'perfil.html';
        }

        function viewSettings() {
            window.location.href = 'configuracao.html';
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('cloudpbx_session');
                window.location.href = 'login.html';
            }
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('dropdownMenu');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Funções dos botões flutuantes
        function openSettings() {
          window.location.href = 'configuracao.html';
        }

        function openHelp() {
            dashboardSync.showDashboardNotification('Central de Ajuda - Em desenvolvimento');
        }

        // Adicionar estilos de animação para as notificações
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(notificationStyles);
    </script>
</body>
</html>